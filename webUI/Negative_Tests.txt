*** Settings ***
Suite Setup
Suite Teardown    Close All Browsers
Test Setup        Open Browser    ${url}    Open Browser    ${url}    remote_url=http://172.18.124.233:4444/wd/hub    browser=firefox    ff_profile_dir=ffprofile
Test Teardown     Close All Browsers
Library           String
Library           Boffin.WebUIlib    0    20    # Boffin framework library

*** Variables ***
${resources_path}    Resources/
${url}            http://10.100.0.6/horizon

*** Test Cases ***
Creating test env
    Log in WebUI by WebTestUser/swordfish
    User click on "Create Environment"
    User set value "test_env" for field Environment Name
    User click on "Create"
    Page should contain element "test_env"

InValid image types
    Log in WebUI by WebTestUser/swordfish
    User click on "test_env"
    User click on "Create Service"
    User select "Internet Information Services" from dropdown list "Service Type"
    User click on "Next"
    User set value "iis_service" for field Service Name
    User set value "P@ssw0rd" for field Administrator password
    User set value "P@ssw0rd" for field Confirm password
    User set value "iis" for field Hostname template
    User click on "Next"
    User select "Windows Server 2012 Standard" from dropdown list "Instance image"
    User click on "Create"

Check regex exspression for AD's name
    Log in WebUI by WebTestUser/swordfish
    User click on "test_env"
    User click on "Create Service"
    User select "Active Directory" from dropdown list "Service Type"
    User click on "Next"
    User set value "a" for field Domain Name
    User click on "Next"
    Page should contain element "Ensure this value has at least 2 characters (it has 1)."
    User set value "@ct!v3" for field Domain Name
    User click on "Next"
    Page should contain element "Only letters, numbers and dashes in the middle are allowed."
    User set value "domain" for field Domain Name
    User click on "Next"
    Page should contain element "Single-level domain is not appropriate."
    User set value "morethan15symbols.beforedot" for field Domain Name
    User click on "Next"
    Page should contain element "Only letters, numbers and dashes in the middle are allowed. "
    User set value ".domain.local" for field Domain Name
    User click on "Next"
    Page should contain element "Period characters are allowed only when they are used to delimit the components of domain style names."

Check regex for IIS's name
    Log in WebUI by WebTestUser/swordfish
    User click on "test_env"
    User click on "Create Service"
    User select "Internet Information Services" from dropdown list "Service Type"
    User click on "Next"
    User set value "a" for field Service Name
    User click on "Next"
    Page should contain element "Ensure this value has at least 2 characters (it has 1)."
    User set value "@ct!v3" for field Service Name
    User click on "Next"
    Page should contain element "Just letters, numbers, underscores and hyphens are allowed."

Check reges for Git repository
    Log in WebUI by WebTestUser/swordfish
    User click on "test_env"
    User click on "Create Service"
    User select "ASP.NET Application" from dropdown list "Service Type"
    User click on "Next"
    User set value "a" for field Git repository
    User click on "Next"
    Page should contain element "Enter correct git repository url"
    User set value "://@:" for field Git repository
    User click on "Next"
    Page should contain element "Enter correct git repository url"

Delete test env
    Log in WebUI by WebTestUser/swordfish
    Select "More" for chosen environment "test_env"
    Select "Delete Environment" for chosen environment "delete_env"
    User confirms deletion
    Page should not contain element "test_env"

*** Keywords ***
Log in WebUI by ${user}/${password}
    Fill Field    User Name    ${user}
    Fill Field    Password    ${password}
    Click on    Sign In
    Navigate to    Murano>Environments

User set value "${value}" for field ${field}
    Fill Field    ${field}    ${value}

Check the status of environment "${name}" (should be "${status}")
    Navigate to    Murano>Environments
    Wait Until Keyword Succeeds    40 min    5s    Check that Status of environment "${name}" is "${status}"

User click on "${element}"
    Click on    ${element}

Page should contain element "${element}"
    Page Should Contain    ${element}

Page should not contain element "${element}"
    Reload Page
    Page Should Not Contain    ${element}

User select "${item}" from dropdown list "${menu}"
    Select Item From List    ${menu}    ${item}

User confirms deletion
    Click On    Confirm deletion

User create Active Directory with domain name "${name}"
    User select "Active Directory" from dropdown list "Service Type"
    User click on "Next"
    User set value "${name}" for field Domain Name
    User set value "P@ssw0rd" for field Administrator password
    User set value "P@ssw0rd" for field Confirm password
    User set value "P@ssw0rd" for field Recovery password
    User set value "P@ssw0rd" for field Confirm recovery password
    User set value "${name}" for field Hostname template
    User click on "Next"
    User select "Windows Server 2012 Standard" from dropdown list "Instance image"
    User click on "Create"

Select "${action}" for chosen ${type} "${env}"
    ${xpath}=    Find Associated Element    ${env}    ${action}
    Click Element    ${xpath}

Check that deploy "${env}" finished
    Navigate To    Murano>Environments
    Select "More" for chosen environment "${env}"
    Select "Show Deployments" for chosen environment "${env}"
    Reload Page
    ${text}=    Get Text    xpath=/html/body/div/div[2]/div[3]/form/table/tbody/tr/td[3]
    Should Be Equal As Strings    ${text}    Successful

User create IIS with name "${name}" ${join} "${domain}"
    User select "Internet Information Services" from dropdown list "Service Type"
    User click on "Next"
    User set value "${name}" for field Service Name
    User set value "P@ssw0rd" for field Administrator password
    User set value "P@ssw0rd" for field Confirm password
    User select "${domain}" from dropdown list "Domain"
    User set value "iis" for field Hostname template
    User click on "Next"
    User select "Windows Server 2012 Standard" from dropdown list "Instance image"
    User click on "Create"
    Page Should Contain    ${name}

User create ASP.NET App with name "${name}" ${join} "${domain}"
    User select "ASP.NET Application" from dropdown list "Service Type"
    User click on "Next"
    User set value "${name}" for field Service Name
    User set value "P@ssw0rd" for field Administrator password
    User set value "P@ssw0rd" for field Confirm password
    User select "${domain}" from dropdown list "Domain"
    User set value "git://github.com/Mirantis/murano-mvc-demo.git" for field Git repository
    User set value "asp" for field Hostname template
    User click on "Next"
    User select "Windows Server 2012 Standard" from dropdown list "Instance image"
    User click on "Create"
    Page should contain element "${name}"

Check that service "${service}" was joined in domain "${domain}"
    User click on "${service}"
    Page should contain element "${domain}"

Delete environment "${name}" after test
    Navigate To    Murano>Environments
    Select "More" for chosen environment "${name}"
    Select "Delete Environment" for chosen environment "${name}"
    User confirms deletion
    Page should not contain element "${name}"

Check that ${subject} of ${element} "${name}" is "${status}"
    ${row}=    Get Table Row With    ${name}
    ${source}=    Get Source
    ${cell}=    Get Web Element Selector    ${subject}    ${source}    th    this
    ${#_of_column}=    Get Substring    ${cell}    -2    -1
    ${text}=    Get Text    xpath=${row}/td[${#_of_column}]
    Should Contain    ${text}    ${status}
